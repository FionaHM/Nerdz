<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>The Idiot Chef</title>
    <meta name="viewport" content="initial-scale=1.0">
    <link rel='shortcut icon' href='assets/images/favicon_tic.ico' type='image/x-icon'/ >
    <!-- Bootstrap CDN-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link href="assets/styles/style.css" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Kalam|Pacifico" rel="stylesheet">
    <!-- Firebase Reference -->
</head>
<body>

<div id="map" class="map-page"></div>


</footer>
    <!--     <script src="https://maps.googleapis.com/maps/api/js?key=MapsAPI&libraries=places&callback=initMap" async defer></script> -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAddiqSupF7BhNzmafgwWImSllcV_zGv7c&libraries=places&callback=initMap" async defer></script>
<script>
// had to move maps in here because of call back issue in heroku
// looked all over the web and tried loads of things but this is the only
// thing we could get to work!
var latitude = 41.881832;
var longitude =  -87.623177; 
// Zoom levels
// 1: World
// 5: Landmass/continent
// 10: City
// 15: Streets
// 20: Buildings

function initMap(){
    // initialised the map and sets the default center location
    var center = new google.maps.LatLng(latitude,longitude);
    var map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: latitude, lng: longitude},
      zoom: 13  // 15 is a street level zoom
    });
    var message='';
    var markersArray =[];
    var infoWindow = new google.maps.InfoWindow({map: map});
    
    // function findNewCenter(latitude,longitude, message){
        var pos = {
          lat: latitude,
          lng: longitude
        };
        infoWindow.setPosition(pos);
        infoWindow.setContent(message);
        map.setCenter(pos);
        centerlocation = map.getCenter();
        // remove entries from db
        // uid = firebase.auth().currentUser.uid;
        // var storefolder = memberFolder.child(uid).child('/stores/');
        // storefolder.set(null);
        // doSearchFromCurrentLocation(centerlocation);
    // }

    // HTML5 geolocation. 
    // gets users current location then does search in predefined radius
    // if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
        message = "<strong>You are here!</strong>"
        console.log(position.coords.latitude,position.coords.longitude,message);
    })
    //   }, function() {
    //     // if user does not allow location just use default
    //     doSearchFromCurrentLocation(center);
    //   });
    // } 
    // else {
    //   // if geolocation doesnt work just center map on predefined coords and search
    //     doSearchFromCurrentLocation(center);
    // }
    
    $(document).on('click', '.store-data', function(){

        latitude = $(this).data('lat');
        longitude = $(this).data('lng');
        $(this).attr('style', 'background-color: darkgrey;');
        message = "<strong>" + $(this).data('name') + "</strong> is here.";

        var pos = {
          lat: latitude,
          lng: longitude
        };

        infoWindow.setPosition(pos);
        infoWindow.setContent(message);
        map.setCenter(pos);

     })

    function clearOverlays() {
      for (var i = 0; i < markersArray.length; i++ ) {
        markersArray[i].setMap(null);
      }
      markersArray.length = 0;
    }

    //Add listener - to allow user to click where they are and it will do another search
    map.addListener("click", function (event) {
        var latitude = event.latLng.lat();
        var longitude = event.latLng.lng();  
        clearOverlays();
        // recenter  map
        map.panTo(new google.maps.LatLng(latitude,longitude));

        message = "<strong>Found You!</strong>";

        findNewCenter(latitude, longitude, message);


    }); //end addListener

    // var count = 0;  

    // // This is where the stores are located and marked on the map
    // function doSearchFromCurrentLocation(centerlocation)   {

    //     // search for 
    //     var request = {
    //         location: centerlocation,
    //         radius: '500',  //500m radius
    //         query: 'grocery'
    //       };
        
    //     service = new google.maps.places.PlacesService(map);
    //     service.textSearch(request, callback);  
  

    //     function callback(results, status) {

    //         $('#map-stores > tbody').empty();
    //         $('#map-stores > tbody:last-child').append('<tr><th> Number </th><th> Store Name </th><th> Store Address </th><th> Open Now </th></tr>');
    //         // count = 0;
    //         if (status == google.maps.places.PlacesServiceStatus.OK) {
    //             var storeLocation = {};
    //             for (var i = 0; i < results.length; i++) {
                    
    //                 try{
    //                   open = results[i].opening_hours.weekday_text;
    //                 }
    //                 catch(e){
    //                   open='No information provided';
    //                 }

    //                 try{
    //                   openNow = results[i].opening_hours.open_now;
            
    //                 }
    //                 catch(e){
    //                   openNow='No information provided';
    //                 }



    //                 storeLocation = {name : results[i].name, formatted_address:results[i].formatted_address,openNow: openNow, openingTime: open, position_lat: results[i].geometry.location.lat(), position_lng: results[i].geometry.location.lng()};
                    
    //                 var marker = new google.maps.Marker({
    //                     position: results[i].geometry.location,
    //                     map: map,
    //                     title: results[i].name + " Address: " + results[i].formatted_address,
    //                     address: results[i].formatted_address
    //                 });

    //                 markersArray.push(marker);
                   
    //                 marker.addListener('click', function(){

    //                 map.setCenter(this.getPosition());
                        
    //                 })

    //                 // store to database for future use
    //                 $('#map-stores > tbody:last-child').append('<tr class="store-data" data-name=' + results[i].name + ' data-lat=' + results[i].geometry.location.lat() + ' data-lng=' + results[i].geometry.location.lng()+ '><td>'+ i +'</td><td>'+ results[i].name  +'</td><td>'+ results[i].formatted_address +'</td><td>'+ openNow +'</td></tr>');
        
    //                 // store to database for future use --  
    //                 uid = firebase.auth().currentUser.uid;
    //                 var storefolder = memberFolder.child(uid).child('/stores/');
            
    //                 storefolder.push(storeLocation);
    //                 storefolder.onDisconnect().set(null);
    //                 storeLocation = {};

    //             }
    //         }
    //     }
    // }
} // end of initmap</script>

<!--  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAddiqSupF7BhNzmafgwWImSllcV_zGv7c&libraries=places&callback=initMap" 
    async defer></script> -->
    <script src="assets/javascript/main-app.js"></script>
    
</body>

</html>
